<div class="page-container">

  <!-- Swipe Container -->
  <div class="swipe-container" *ngIf="selectedMission && clientMissions.length > 0">
    <!-- Mission Context Bar - Above Cards -->
    <div class="mission-context-bar">
      <div class="mission-info">
        <fa-icon [icon]="faBriefcase" class="mission-icon"></fa-icon>
        <span class="mission-title">{{ selectedMission.titre }}</span>
        <span class="mission-budget">{{ selectedMission.budget }} TND</span>
      </div>
      <button class="switch-mission-btn" (click)="openMissionModal()" title="Changer de mission">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </svg>
        <span class="switch-text">Switch</span>
      </button>
    </div>

    <!-- Loading Freelancers State -->
    <div *ngIf="isLoadingFreelancers" class="loading-spinner-overlay">
      <div class="spinner"></div>
    </div>

    <!-- No Freelancers State -->
    <div *ngIf="!isLoadingFreelancers && freelancers.length === 0" class="no-freelancers">
      <div class="icon-container">
        <fa-icon [icon]="faUserTie" size="3x"></fa-icon>
      </div>
      <h2>Aucun freelance pour cette mission</h2>
      <p>Aucun freelance n'a encore manifesté son intérêt. Revenez plus tard !</p>
      <button (click)="reloadFreelancers()" class="retry-button">
        <fa-icon [icon]="faSync"></fa-icon> Recharger
      </button>
    </div>

    <!-- Swipe Area: Cards + Actions -->
    <div class="swipe-area" *ngIf="!isLoadingFreelancers && freelancers.length > 0">
      <!-- Cards Stack (cloned from swipefreelencer) -->
      <div class="card-stack-container">
        <ng-container *ngFor="let freelancer of freelancers; let i = index; trackBy: trackById">
          <div class="card-wrapper" [style.zIndex]="i" [class.animating]="animating && i === currentIndex">
            <div class="swipe-card"
                 [class.like]="freelancer.decision === 'like'"
                 [class.dislike]="freelancer.decision === 'dislike'"
                 (pointerdown)="handlePointerDown($event, i)"
                 (pointermove)="handlePointerMove($event)"
                 (pointerup)="handlePointerUp($event, i)"
                 (pointercancel)="handlePointerUp($event, i)">

              <div class="swipe-overlay like" [style.opacity]="getLikeOpacity(i)">
                LIKE
                <div class="overlay-extra-info" *ngIf="freelancer.matchScore">
                  <fa-icon [icon]="faFire"></fa-icon>
                  <span>{{ (freelancer.matchScore || 0) * 100 | number:'1.0-0' }}% Match</span>
                </div>
              </div>
              <div class="swipe-overlay dislike" [style.opacity]="getDislikeOpacity(i)">
                NOPE
                <div class="overlay-extra-info">
                  <span>Passer</span>
                </div>
              </div>

              <div class="card-content">
                <!-- Top bar: freelancer info (left) + top chips (right) -->
                <div class="top-bar">
                  <div class="client-info">
                    <img [src]="freelancer.photoUrl || freelancer.photoProfilUrl || 'https://i.pravatar.cc/50?u=' + freelancer.id" alt="Avatar freelance" class="client-avatar">
                    <div class="client-details">
                      <div class="client-name-row">
                        <span class="client-name">{{ freelancer.prenom }} {{ freelancer.nom }}</span>
                      </div>
                      <div class="client-badges">
                        <span class="badge verified" *ngIf="isFreelancerVerified(freelancer)"><fa-icon [icon]="faCheckCircle"></fa-icon> Vérifié</span>
                        <span class="badge gouv-badge" *ngIf="freelancer.gouvernorat || freelancer.localisation">
                          <fa-icon [icon]="faMapPin"></fa-icon>
                          {{ freelancer.gouvernorat || freelancer.localisation }}
                        </span>
                        <span class="badge match-score" *ngIf="freelancer.matchScore"><fa-icon [icon]="faStar"></fa-icon> {{ (freelancer.matchScore || 0) * 100 | number:'1.0-0' }}% Match</span>
                      </div>
                    </div>
                  </div>
                  <div class="top-chips">
                    <span class="urgent-badge" *ngIf="freelancer.badgePrincipal">
                      <fa-icon [icon]="faCheckCircle"></fa-icon>
                      {{ freelancer.badgePrincipal }}
                    </span>

                    <!-- Social links: LinkedIn / GitHub (ultra moderne) -->
                    <a *ngIf="freelancer.linkedinUrl"
                       class="social-button linkedin"
                       [href]="freelancer.linkedinUrl"
                       target="_blank" rel="noopener noreferrer"
                       title="Voir le profil LinkedIn"
                       (click)="$event.stopPropagation()"
                       (pointerdown)="$event.stopPropagation()">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                        <path fill="currentColor" d="M20.447 20.452H17.21v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.447-2.136 2.943v5.663H9.005V9h3.111v1.561h.045c.434-.82 1.494-1.686 3.073-1.686 3.29 0 3.897 2.165 3.897 4.985v6.592zM5.337 7.433a1.804 1.804 0 1 1 0-3.608 1.804 1.804 0 0 1 0 3.608zM6.78 20.452H3.893V9H6.78v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.226.792 24 1.771 24h20.451C23.2 24 24 23.226 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                      </svg>
                    </a>

                    <a *ngIf="freelancer.githubUrl"
                       class="social-button github"
                       [href]="freelancer.githubUrl"
                       target="_blank" rel="noopener noreferrer"
                       title="Voir le GitHub"
                       (click)="$event.stopPropagation()"
                       (pointerdown)="$event.stopPropagation()">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                        <path fill="currentColor" d="M12 .5C5.73.5.77 5.46.77 11.74c0 4.93 3.19 9.11 7.62 10.59.56.1.77-.24.77-.54 0-.27-.01-1.16-.02-2.1-3.1.67-3.76-1.32-3.76-1.32-.51-1.29-1.25-1.63-1.25-1.63-1.02-.7.08-.68.08-.68 1.13.08 1.72 1.16 1.72 1.16 1 .1.68-.77 1.86-1.2.1-.73.39-1.22.72-1.5-2.48-.28-5.1-1.24-5.1-5.54 0-1.22.44-2.22 1.16-3-.12-.29-.5-1.46.11-3.04 0 0 .94-.3 3.08 1.15a10.7 10.7 0 0 1 2.8-.38c.95 0 1.9.13 2.8.38 2.14-1.45 3.08-1.15 3.08-1.15.61 1.58.24 2.75.12 3.04.72.78 1.16 1.78 1.16 3 0 4.31-2.62 5.26-5.11 5.54.4.35.76 1.03.76 2.07 0 1.49-.01 2.69-.01 3.06 0 .3.21.65.78.54 4.42-1.49 7.61-5.66 7.61-10.59C23.23 5.46 18.27.5 12 .5z"/>
                      </svg>
                    </a>
                  </div>
                </div>

                <!-- Title + Description Toggle -->
                <div class="title-row">
                  <h3 class="mission-title">{{ freelancer.titreProfil || (freelancer.prenom + ' ' + freelancer.nom) }}</h3>
                  <button
                    class="description-toggle"
                    type="button"
                    (click)="$event.stopPropagation(); toggleDescription(freelancer.id)"
                    (pointerdown)="$event.stopPropagation()"
                    (pointerup)="$event.stopPropagation()"
                    (mousedown)="$event.stopPropagation()"
                    (mouseup)="$event.stopPropagation()"
                    (touchstart)="$event.stopPropagation()"
                    (touchend)="$event.stopPropagation()"
                    [attr.aria-expanded]="expandedDescriptions[freelancer.id] ? 'true' : 'false'">
                    <fa-icon [icon]="faChevronDown" [class.rotated]="expandedDescriptions[freelancer.id]"></fa-icon>
                  </button>
                </div>

                <!-- Meta Grid -->
                <div class="mission-meta">
                  <div class="meta-item budget" *ngIf="getTarifLabelValue(freelancer) as tarif">
                    <span class="currency-chip">DT</span>
                    {{ tarif.value }}
                  </div>
                  <div class="meta-item duration" *ngIf="freelancer.chargeHebdoSouhaiteeJours"><fa-icon [icon]="faClock"></fa-icon> {{ freelancer.chargeHebdoSouhaiteeJours }} j/sem</div>
                  <div class="meta-item modality" *ngIf="freelancer.mobilite"><fa-icon [icon]="faBriefcase"></fa-icon> {{ freelancer.mobilite }}</div>
                  <div class="meta-item category" *ngIf="freelancer.niveauExperience"><fa-icon [icon]="faStar"></fa-icon> {{ freelancer.niveauExperience | titlecase }}</div>
                  <div class="meta-item experience" *ngIf="freelancer.anneesExperience != null"><fa-icon [icon]="faCheckCircle"></fa-icon> {{ freelancer.anneesExperience }} ans</div>
                  <div class="meta-item workload" *ngIf="freelancer.disponibilite"><fa-icon [icon]="faClock"></fa-icon> {{ freelancer.disponibilite }}</div>
                  <div class="meta-item deadline" *ngIf="freelancer.dateDisponibilite"><fa-icon [icon]="faCalendarDay"></fa-icon> Disponible: {{ freelancer.dateDisponibilite | date:'dd/MM' }}</div>
                </div>

                <!-- Media Preview (portfolio) -->
                <div class="media-preview" *ngIf="freelancer.portfolioUrls && freelancer.portfolioUrls.length">
                  <img [src]="freelancer.portfolioUrls[0]" alt="Aperçu portfolio" />
                  <div class="media-count" *ngIf="freelancer.portfolioUrls.length > 1">+{{ freelancer.portfolioUrls.length - 1 }}</div>
                </div>

                <!-- Skills KPI -->
                <div class="mission-skills" *ngIf="freelancer.competences && freelancer.competences.length">
                  <span class="kpi-badge" *ngFor="let skill of freelancer.competences | slice:0:6">
                    <span class="kpi-dot"></span>
                    <span class="kpi-label">{{ skill }}</span>
                  </span>
                </div>

                <!-- Description Expandable -->
                <div class="mission-description" *ngIf="expandedDescriptions[freelancer.id]">
                  <div class="description-content">
                    <p>{{ safeFreelancerText(freelancer) || 'Aucune description disponible' }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Action Buttons -->
      <div class="swipe-actions">
        <button class="action-button dislike" (click)="onDislike()">
          <fa-icon [icon]="faTimes" class="custom-size"></fa-icon>
        </button>
        <button class="action-button select" (click)="onLike()">
          <fa-icon [icon]="faCheck" class="custom-size"></fa-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Initial state : No mission selected -->
  <div *ngIf="(!selectedMission || clientMissions.length === 0) && !isLoadingMissions" class="initial-prompt">
    <fa-icon [icon]="faBriefcase" size="4x" class="prompt-icon"></fa-icon>
    <h2>Bienvenue !</h2>
    <p *ngIf="clientMissions.length === 0">Aucune mission active trouvée. Créez une nouvelle mission pour commencer.</p>
    <p *ngIf="clientMissions.length > 0">Pour commencer, veuillez sélectionner l'une de vos missions dans le menu ci-dessus.</p>
  </div>
</div>

<!-- Mission Selection Modal (Glass style) -->
<div class="mission-modal-backdrop" *ngIf="showMissionModal" (click)="closeMissionModal()">
  <div class="mission-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="title">
        <fa-icon [icon]="faBriefcase" class="dropdown-icon"></fa-icon>
        <span>Choisir une mission</span>
      </div>
      <button class="close-btn" type="button" (click)="closeMissionModal()" aria-label="Fermer">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path fill="currentColor" d="M18.3 5.71L12 12.01l-6.29-6.3L4.3 7.12l6.3 6.29-6.3 6.29 1.41 1.42L12 14.84l6.29 6.28 1.42-1.41-6.3-6.3 6.3-6.29z"/>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <div *ngIf="isLoadingMissions" class="dropdown-item loading">
        <div class="loading-spinner"></div>
        <span>Chargement...</span>
      </div>
      <div *ngIf="!isLoadingMissions && clientMissions.length === 0" class="dropdown-item empty">
        <fa-icon [icon]="faBriefcase" class="empty-icon"></fa-icon>
        <span>Aucune mission active trouvée.</span>
      </div>
      <div class="modal-missions">
        <button class="mission-row" *ngFor="let mission of clientMissions; trackBy: trackById" (click)="selectMission(mission)" [class.active]="selectedMission?.id === mission.id">
          <div class="mission-row-left">
            <div class="mission-item-icon"><fa-icon [icon]="faBriefcase"></fa-icon></div>
            <div class="mission-row-text">
              <div class="mission-row-title">{{ mission.titre }}</div>
              <div class="mission-row-sub">Budget: {{ mission.budget }} TND</div>
            </div>
          </div>
          <div class="mission-row-right" *ngIf="selectedMission?.id === mission.id">
            <fa-icon [icon]="faCheck"></fa-icon>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Match Overlay -->
<div class="match-overlay" *ngIf="matchPopup">
  <div class="confetti-container">
    <!-- Le SCSS générera 50 confettis avec des couleurs et délais aléatoires -->
    <div class="confetti"></div> <div class="confetti"></div> <div class="confetti"></div>
    <div class="confetti"></div> <div class="confetti"></div> <div class="confetti"></div>
    <div class="confetti"></div> <div class="confetti"></div> <div class="confetti"></div>
    <div class="confetti"></div> <div class="confetti"></div> <div class="confetti"></div>
  </div>
  <div class="match-card animate-in">
    <div class="match-header">
      <span class="match-title"><span>It's a Match!</span></span>
    </div>
    <div class="match-avatars">
      <div class="avatar-container client-avatar">
        <img [src]="matchPopup.clientPhotoUrl || 'https://placehold.co/120x120/FF6B2E/FFFFFF?text=C'" alt="Photo du Client">
      </div>
      <div class="avatar-container freelance-avatar">
        <img [src]="matchPopup.freelancePhotoUrl || 'https://placehold.co/120x120/4A90E2/FFFFFF?text=F'" alt="Photo du Freelance">
      </div>
      <div class="heart-icon">❤️</div>
    </div>
    <p class="match-text">
      Vous et <strong>{{ matchPopup.freelanceNom }}</strong> êtes maintenant connectés pour la mission :<br>
      <em>"{{ matchPopup.missionTitre }}"</em>
    </p>
    <div class="match-actions">
      <button class="action-chat" (click)="goToChat()">Ouvrir la discussion</button>
      <button class="action-keep-swiping" (click)="matchPopup = undefined">Continuer à explorer</button>
    </div>
  </div>
</div>


