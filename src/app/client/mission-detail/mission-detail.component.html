<div class="mission-detail-modal">
  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement des détails de la mission...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="isError()" class="error-container">
    <fa-icon [icon]="faExclamationTriangle" class="error-icon"></fa-icon>
    <h3>Erreur de chargement</h3>
    <p>{{ errorMessage() }}</p>
  </div>

  <!-- Mission Details -->
  <div *ngIf="!isLoading() && !isError() && mission()" class="mission-content">
    
    <!-- Header Section -->
    <header class="mission-header">
      <!-- Zone Gauche : Titre + Chips -->
      <div class="header-left">
        <div class="title-section">
          <h1 class="mission-title" [title]="mission()?.titre">{{ mission()?.titre }}</h1>
          <div class="chips-container">
            <span class="chip chip--id" title="ID de la mission">
              <fa-icon [icon]="faTag"></fa-icon>
              <span>#{{ mission()?.id }}</span>
            </span>
            <span class="chip chip--category" title="Catégorie de la mission">
              <fa-icon [icon]="faBriefcase"></fa-icon>
              <span>{{ getCategorieLabel(mission()?.categorie) }}</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Zone Centre : Méta courte -->
      <div class="header-center">
        <div class="meta-info">
          <div class="meta-item" *ngIf="mission()?.budget">
            <fa-icon [icon]="faMoneyBillWave"></fa-icon>
            <span>{{ formatCurrency(mission()?.budget, mission()?.devise) }}</span>
          </div>
          <div class="meta-item" *ngIf="mission()?.delaiLivraison">
            <fa-icon [icon]="faCalendarAlt"></fa-icon>
            <span>{{ formatDate(mission()?.delaiLivraison) }}</span>
          </div>
        </div>
      </div>

      <!-- Zone Droite : États + Bouton Fermer -->
      <div class="header-right">
        <div class="status-group">
          <div class="status-badge" [ngClass]="statusClass()" [title]="getStatusLabel(mission()?.statut)">
            <fa-icon [icon]="statusIcon()"></fa-icon>
            <span>{{ getStatusLabel(mission()?.statut) }}</span>
          </div>
          <div *ngIf="mission()?.urgent" class="urgent-badge" title="Mission urgente">
            <fa-icon [icon]="faExclamationTriangle"></fa-icon>
            <span>Urgent</span>
          </div>
        </div>
        
        <button class="close-modal-btn" 
                (click)="closeModal()" 
                aria-label="Fermer la modal"
                title="Fermer">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="mission-main">
      
      <!-- Overview Section -->
      <section class="overview-section">
        <h2 class="section-title">
          <fa-icon [icon]="faEye"></fa-icon>
          Aperçu de la mission
        </h2>
        
        <div class="overview-grid">
          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faBuilding"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Modalité de travail</h4>
              <p>{{ getModaliteLabel(mission()?.modaliteTravail) }}</p>
            </div>
          </div>

          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faMapPin"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Gouvernorat</h4>
              <p>{{ getGouvernoratLabel(mission()?.gouvernorat) }}</p>
            </div>
          </div>

          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faCalendarAlt"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Date de début souhaitée</h4>
              <p>{{ formatDate(mission()?.dateDebutSouhaitee) }}</p>
            </div>
          </div>

          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faClock"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Charge hebdomadaire</h4>
              <p>{{ mission()?.chargeHebdoJours || '-' }} jours/semaine</p>
            </div>
          </div>

          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faBriefcase"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Durée estimée</h4>
              <p>{{ mission()?.dureeEstimeeJours || '-' }} jours</p>
            </div>
          </div>

          <div class="overview-card">
            <div class="card-icon">
              <fa-icon [icon]="faFileAlt"></fa-icon>
            </div>
            <div class="card-content">
              <h4>Qualité du brief</h4>
              <p>{{ getNiveauBriefLabel(mission()?.qualiteBrief) }}</p>
            </div>
          </div>
        </div>

        <!-- Experience Level & Badges -->
        <div class="experience-section">
          <div class="experience-level">
            <h4>Niveau d'expérience requis</h4>
            <div class="level-badge">
              <fa-icon [icon]="faGraduationCap"></fa-icon>
              <span>{{ mission()?.niveauExperienceMin || '-' }}</span>
            </div>
          </div>

          <div *ngIf="mission()?.badges?.length" class="badges-section">
            <h4>Badges</h4>
            <div class="badges-list">
              <span *ngFor="let badge of mission()?.badges" class="badge">
                <fa-icon [icon]="faStar"></fa-icon>
                {{ badge }}
              </span>
            </div>
          </div>
        </div>

                 <!-- Freelance Section (seulement si assigné) -->
         <div *ngIf="mission()?.freelanceNomComplet" class="freelance-section">
           <h4>Freelance assigné</h4>
           <div class="freelance-card">
             <div class="freelance-avatar">
               <fa-icon [icon]="faUser"></fa-icon>
             </div>
             <div class="freelance-info">
               <h5>{{ mission()?.freelanceNomComplet }}</h5>
               <p class="freelance-status">Freelance assigné</p>
             </div>
           </div>
         </div>
      </section>

      <!-- Payment Section -->
      <section class="payment-section">
        <h2 class="section-title">
          <fa-icon [icon]="faCreditCard"></fa-icon>
          Paiements & Progression
        </h2>

        <div class="payment-overview">
          <div class="payment-stats">
            <div class="stat-card">
              <div class="stat-value">{{ formatCurrency(totalAmount(), mission()?.devise) }}</div>
              <div class="stat-label">Total brut</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ formatCurrency(paidAmount(), mission()?.devise) }}</div>
              <div class="stat-label">Montant payé</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{ progressPercentage() }}%</div>
              <div class="stat-label">Progression</div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="progressPercentage()"></div>
          </div>
        </div>

        <!-- Tranches List -->
        <div class="tranches-list">
          <h3>Tranches de paiement</h3>
          <div class="tranche-item" *ngFor="let tranche of mission()?.paiements?.tranches || []">
            <div class="tranche-info">
              <div class="tranche-header">
                <h4>{{ tranche.titre }}</h4>
                <div class="tranche-badges">
                  <span *ngIf="tranche.required" class="badge required">Requis</span>
                  <span *ngIf="tranche.finale" class="badge final">Finale</span>
                  <span class="badge status" [ngClass]="getTrancheStatusClass(tranche)">
                    <fa-icon [icon]="getTrancheStatusIcon(tranche)" class="badge-icon"></fa-icon>
                    {{ getTrancheStatusLabel(tranche) }}
                  </span>
                </div>
              </div>
              <div class="tranche-details">
                <span class="tranche-amount">{{ formatCurrency(tranche.montantBrut, mission()?.devise) }}</span>
                <span class="tranche-order">Tranche #{{ tranche.ordre }}</span>
              </div>
            </div>
            
            <div class="tranche-actions">
              <!-- Bouton de paiement - seulement si la tranche est payable -->
              <button 
                *ngIf="isTranchePayable(tranche)" 
                class="btn-pay"
                (click)="onPayerTranche(tranche)">
                <fa-icon [icon]="faCreditCard"></fa-icon>
                Payer
              </button>
              
              <!-- Bouton pour voir les livrables de cette tranche -->
              <button 
                *ngIf="hasLivrablesForTranche(tranche)"
                class="btn-livrables"
                (click)="openLivrablesForTranche(tranche)"
                [title]="'Voir les livrables (' + getLivrablesCountForTranche(tranche) + ')'">
                <fa-icon [icon]="faFileAlt"></fa-icon>
                <span class="livrables-count">{{ getLivrablesCountForTranche(tranche) }}</span>
              </button>
              
              
              <!-- Statut payé - affichage de confirmation -->
              <div *ngIf="isTranchePaid(tranche)" class="tranche-status-paid">
                <fa-icon [icon]="getTrancheStatusIcon(tranche)" class="status-icon"></fa-icon>
                <span class="status-text">{{ getTrancheStatusLabel(tranche) }}</span>
              </div>
              
              <!-- Statut rejeté - affichage d'erreur -->
              <div *ngIf="isTrancheRejected(tranche)" class="tranche-status-rejected">
                <fa-icon [icon]="getTrancheStatusIcon(tranche)" class="status-icon"></fa-icon>
                <span class="status-text">{{ getTrancheStatusLabel(tranche) }}</span>
              </div>
              
              <!-- Statut en erreur - affichage d'erreur -->
              <div *ngIf="isTrancheInError(tranche)" class="tranche-status-error">
                <fa-icon [icon]="getTrancheStatusIcon(tranche)" class="status-icon"></fa-icon>
                <span class="status-text">{{ getTrancheStatusLabel(tranche) }}</span>
              </div>
              
              <!-- Statut en attente - affichage d'attente -->
              <div *ngIf="isTrancheNotPaid(tranche) && !isTranchePayable(tranche)" class="tranche-status-pending">
                <fa-icon [icon]="getTrancheStatusIcon(tranche)" class="status-icon"></fa-icon>
                <span class="status-text">{{ getTrancheStatusLabel(tranche) }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Note: La section des livrables a été intégrée dans les tranches de paiement -->

      <!-- Files Section -->
      <section *ngIf="(mission()?.mediaUrls?.length || 0) > 0 || mission()?.videoBriefUrl" class="files-section">
        <h2 class="section-title">
          <fa-icon [icon]="faDownload"></fa-icon>
          Fichiers & Médias
        </h2>

        <!-- Media Gallery -->
        <div *ngIf="mission()?.mediaUrls?.length" class="media-gallery">
          <h3>Images & Maquettes</h3>
          <div class="gallery-grid">
            <div 
              *ngFor="let mediaUrl of mission()?.mediaUrls; let i = index"
              class="gallery-item"
              (click)="openFile(mediaUrl)">
              <img [src]="mediaUrl" [alt]="'Media ' + (i + 1)" />
              <div class="gallery-overlay">
                <fa-icon [icon]="faEye"></fa-icon>
              </div>
            </div>
          </div>
        </div>

        <!-- Video Brief -->
        <div *ngIf="mission()?.videoBriefUrl" class="video-section">
          <h3>Vidéo de présentation</h3>
          <div class="video-container">
            <button class="video-btn" (click)="openVideo(mission()?.videoBriefUrl!)">
              <fa-icon [icon]="faPlay"></fa-icon>
              <span>Regarder la vidéo</span>
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Modal pour afficher les livrables d'une tranche spécifique -->
<div class="modal-backdrop" *ngIf="isLivrablesModalOpen()" (click)="closeLivrablesModal()">
  <div class="modal-panel livrables-modal" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>Livrables - {{ selectedTrancheForLivrables()?.titre }}</h2>
      <button class="close-btn" (click)="closeLivrablesModal()">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </header>
    
    <div class="modal-content">
      <div class="tranche-info" *ngIf="selectedTrancheForLivrables() as tranche">
        <div class="tranche-summary">
          <span class="tranche-order">Tranche #{{ tranche.ordre }}</span>
          <span class="tranche-amount">{{ formatCurrency(tranche.montantBrut, mission()?.devise) }}</span>
          <span class="tranche-status" [ngClass]="getTrancheStatusClass(tranche)">
            <fa-icon [icon]="getTrancheStatusIcon(tranche)"></fa-icon>
            {{ getTrancheStatusLabel(tranche) }}
          </span>
        </div>
      </div>

      <!-- Liste des livrables pour cette tranche -->
      <div class="livrables-list" *ngIf="selectedTrancheForLivrables() as tranche">
        <div *ngFor="let livrable of getLivrablesForTranche(tranche)" class="livrable-item">
          <div class="livrable-header">
            <h4>{{ livrable.titre }}</h4>
            <div class="livrable-status" [ngClass]="livrableStatusClass(livrable.status)">
              {{ livrable.status || '-' }}
            </div>
          </div>

          <div *ngIf="livrable.description" class="livrable-description">
            {{ livrable.description }}
          </div>

          <div class="livrable-meta">
            <span class="livrable-date">
              <fa-icon [icon]="faCalendarAlt"></fa-icon>
              {{ formatDate(livrable.dateEnvoi) }}
            </span>
          </div>

          <!-- Files -->
          <div *ngIf="livrable.cheminsFichiers?.length" class="livrable-files">
            <h5>Fichiers</h5>
            <div class="files-list">
              <button 
                *ngFor="let file of livrable.cheminsFichiers; let i = index"
                class="file-btn"
                (click)="openFile(file)">
                <fa-icon [icon]="faDownload"></fa-icon>
                Fichier {{ i + 1 }}
              </button>
            </div>
          </div>

          <!-- External Links -->
          <div *ngIf="livrable.liensExternes?.length" class="livrable-links">
            <h5>Liens externes</h5>
            <div class="links-list">
              <a 
                *ngFor="let link of livrable.liensExternes"
                [href]="link"
                target="_blank"
                class="link-btn">
                <fa-icon [icon]="faLink"></fa-icon>
                {{ link }}
              </a>
            </div>
          </div>

          <!-- Actions -->
          <div *ngIf="livrable.status === 'EN_ATTENTE'" class="livrable-actions">
            <button 
              *ngIf="livrable.canValidate"
              class="btn-validate"
              (click)="onValiderLivrable(livrable)">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              Valider
            </button>
            <button 
              *ngIf="livrable.canReject"
              class="btn-reject"
              (click)="onRejeterLivrable(livrable)">
              <fa-icon [icon]="faTimes"></fa-icon>
              Rejeter
            </button>
          </div>
        </div>

        <!-- Message si aucun livrable -->
        <div *ngIf="getLivrablesForTranche(tranche).length === 0" class="no-livrables">
          <fa-icon [icon]="faFileAlt" class="no-livrables-icon"></fa-icon>
          <p>Aucun livrable associé à cette tranche</p>
        </div>
      </div>
    </div>
  </div>
</div>
